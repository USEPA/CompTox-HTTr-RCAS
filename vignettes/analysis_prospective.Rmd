---
title: "Prospective Profiling of Data-Poor Chemicals"
author: "Jesse Rogers"
date: "December 28, 2023"
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    df_print: paged
    code_folding: show
---

Assessment of prospective chemical screening data for chemicals predicted to
perturb key molecular targets in high-throughtput transcriptomics.

# Setup Environment

```{r env-setup, message=FALSE}
# import packages for visualization
# (note that other required packages will be imported by pipeline scripts)
library(ggplot2)
library(dplyr)
library(tidyr)
library(readxl)
library(RColorBrewer)
library(ggrepel)

# set directories (`dir_home` should be set to the top-level directory)
dir_home <- "~/NAM-integration/NAM-integration-pilot-packaged/"
dir_scripts <- paste0(dir_home, "scripts/")
setwd(dir_home)

source(paste0(dir_scripts, "pipeline_RCAS_profiling.R"))

# set paths for rcas/framework results
path_rcas <- c(
  paste0(dir_home, "data/examples/rcas_heparg_gene.RData"),
  paste0(dir_home, "data/examples/rcas_u2os_gene.RData")
)
path_export <- paste0(
  dir_home,
  c(
    "data/examples/framework_heparg.RData",
    "data/examples/framework_u2os.RData"
  )
)

th <- theme(text = element_text(family = "Helvetica"))
```

```{r import-framework}
# import rcas results
rcas_heparg <- selectRCASGenes(path_rcas[1])
rcas_u2os <- selectRCASGenes(path_rcas[2])

# import framework results
load(path_export[1])
heparg_full <- compare_full
heparg_sum <- compare_sum
load(path_export[2])
u2os_full <- compare_full
u2os_sum <- compare_sum

# incorporate reference chemical annotations into full combined df
combined_full <- rbind(
  mutate(
    heparg_full,
    source = "heparg",
    ref_class = rcas_heparg$httr.wide$ref_class[
      match(dtxsid, rcas_heparg$httr.wide$dtxsid)
    ]
  ),
  mutate(
    u2os_full,
    source = "u2os",
    ref_class = rcas_u2os$httr.wide$ref_class[
      match(dtxsid, rcas_u2os$httr.wide$dtxsid)
    ]
  )
) %>%
  mutate(source_signature = gsub("_up|_dn", "", paste0(source, "_", signature)))

combined_sum <- rbind(
  mutate(heparg_sum, source = "heparg"),
  mutate(u2os_sum, source = "u2os")
) %>%
  mutate(
    source_signature = gsub("_up|_dn", "", paste0(source, "_", signature)),
    signature = gsub("_up|_dn", "", signature)
  )
```

## Import Data

Data were received from Eurofins DiscoverX and Eurofins Panlabs separately as 
control-normalized (i.e. percent activation) values.

Importantly, DiscoverX data were received as individual replicate-level data,
whereas Panlabs data were pre-averaged. Both forms are accepted by `tcplfit2`,
but may potentially alter confidence intervals for potency estimates.

```{r import-eurofins}
# import chemical id table
httr_chems <- read_xlsx(
  paste0(dir_home, "data/eurofins/Eurofins_expt_chemicals_2022-04-22.xlsx"),
  sheet = "Sheet1"
)
table(httr_chems$assay_target, httr_chems$reference_type)

# import DiscoverX (xlsx) and Panlabs (txt)
ef_dx <- read_xlsx(
  paste0(dir_home, "data/eurofins/US034-0017803-O_nhrSCAN_ _Data_Sheet.xlsx"),
  sheet = "Primary Data"
)
ef_pl <- read.table(
  paste0(dir_home, "data/eurofins/US034-0017803.TXT"),
  sep = "\t",
  header = TRUE,
  stringsAsFactors = FALSE
)

# import sample keys
key_dx <- read_xlsx(
  paste0(dir_home, "data/eurofins/EPA_778506_EurofinsUS_30_20220915_key.xlsx"),
  sheet = "Order594-Mosaic 778506 & 778507"
)
key_pl <- read_xlsx(
  paste0(dir_home, "data/eurofins/EPA_778508_EurofinsUS_32_20220915_key_revised.xlsx"),
  sheet = "Order595-Mosaic 778508 & 779139"
)
```

## Harmonize Data

Individual tables are harmonized for matching structure as well as to match
expected inputs for concentration-response profiling via `tcplfit2`. Assay 
component endpoint names (`aenm` column) are also constructed to match naming
conventions in invitrodb v4.1.

```{r harmonize-dx}
# format DiscoverX data:
  # pivot replicate-level data to long form
  # construct aenms
  # add chemical identifiers from sample key
  # harmonize columns/colnames
proc_dx <- ef_dx %>%
  pivot_longer(
    cols = c(`Value 1`, `Value 2`),
    names_to = "repi",
    values_to = "resp"
  ) %>%
  mutate(
    repi = gsub("Value ", "", repi),
    aenm = paste0("EF_DX_NR_h", `Assay Target`)
  ) %>%
  left_join(
    ., select(key_dx, EPA_SAMPLE_ID, DTXSID, PREFERRED_NAME),
    by = c("Compound Name" = "EPA_SAMPLE_ID")
  ) %>%
  select(
    aenm, `Compound Name`, DTXSID, PREFERRED_NAME,
    repi, `Conc(uM)`, resp, `% Efficacy`
  )
colnames(proc_dx) <- c(
  "aenm", "sample_id", "dtxsid", "name",
  "repi", "conc", "resp", "resp.pc"
)

proc_dx %>%
  arrange(aenm, dtxsid, repi, conc) %>%
  mutate(across(where(is.numeric), ~ signif(.x, 3))) %>%
  DT::datatable()
```

```{r harmonize-pl}
# format Panlabs data:
  # pivot agonist/antagonist modes to long-form + remove missing rows
  # construct assay metadata columns
  # construct aenms
  # add chemical identifiers from sample key
  # harmonize columns/colnames
proc_pl <- ef_pl %>%
  as_tibble() %>%
  pivot_longer(
    cols = c(Agonist.Response, Antagonist.Response),
    names_to = "endpoint",
    values_to = "resp.pc"
  ) %>%
  filter(!is.na(resp.pc)) %>%
  mutate(
    repi = "12",
    replicate_id = paste0(Compound.Code, "_", repi),
    endpoint = gsub(".Response", "", endpoint),
    target = case_when(
      grepl("hERG", Ascii.Assay.Name) ~ "KCNH2",
      grepl("RARG", Ascii.Assay.Name) ~ "RARG",
      grepl("RXRbeta", Ascii.Assay.Name) ~ "RXRB"
    ),
    aenm = case_when(
      `Route.of.Administration` == "Radioligand Binding" ~ paste0("ERF_PL_IC_h", target),
      TRUE ~ paste0("ERF_PL_NR_COA_h", target)
    ),
    resp = NA
  ) %>%
  left_join(
    ., select(key_pl, EPA_SAMPLE_ID, DTXSID, PREFERRED_NAME),
    by = c("Compound.Code" = "EPA_SAMPLE_ID")
  ) %>%
  select(
    aenm, Compound.Code, DTXSID, PREFERRED_NAME,
    repi, Concentration.of.Test.Compound, resp, resp.pc
  )
colnames(proc_pl) <- c(
  "aenm", "sample_id", "dtxsid", "name",
  "repi", "conc", "resp", "resp.pc"
)

proc_pl %>%
  arrange(aenm, dtxsid, repi, conc) %>%
  mutate(across(where(is.numeric), ~ signif(.x, 3))) %>%
  DT::datatable()
```

```{r combine-datasets}
proc_all <- rbind(proc_dx, proc_pl)

# define concentration indices (cndx) + log-scale conc (logc)
proc_all <- proc_all %>%
  group_by(aenm, dtxsid, repi) %>%
  mutate(
    sample_repi_id = paste0(sample_id, "_", repi),
    cndx = row_number(conc),
    logc = log10(conc)
  )
```

# Conduct Concentration-Response Profiling

## Determine response cutoff levels

Baseline median absolute deviations (BMADs) are determined for each assay
from response values using the 2 lowest concentrations of all test chemicals, as
well-level data is not reported for positive/negative controls.

Because cutoff levels can be high due to the biased selection of chemicals
likely to demonstrate bioactivity in each assay, minimum and maximum thresholds
are employed for each cutoff:

Rule | Cutoff
-----|-------
3*BMAD < 0.2 | 0.2
0.2 < 3*BMAD < 0.5 | 3*BMAD
3*BMAD > 0.5 | 0.5

```{r cr-bmads}
# define bmad + onesd + cutoff from lowest 2 concentrations
bmads <- proc_all %>%
  group_by(aenm) %>%
  filter(cndx <= 2) %>%
  summarise(
    bmad = mad(resp.pc),
    bmad3 = 3 * bmad,
    onesd = sd(resp.pc),
    cutoff = case_when(
      bmad3 < 20 ~ 20,
      bmad3 > 50 ~ 50,
      TRUE ~ bmad3
    )
  )
proc_all <- left_join(proc_all, bmads, by = "aenm")
bmads %>%
  mutate(across(-aenm, ~ signif(.x, 3))) %>%
  DT::datatable()
```

## Perform curve-fitting

```{r cr-run}
fit_all <- data.frame()
for (aenm_fit in unique(proc_all$aenm)) {
  proc_aenm <- filter(proc_all, aenm == aenm_fit)
  for (spid_fit in unique(proc_aenm$sample_id)) {
    proc_spid <- arrange(filter(proc_aenm, sample_id == spid_fit), conc)
    # pull conc/resp/noise data into list object
    dat.obj <- list(
      conc = proc_spid$conc,
      resp = proc_spid$resp.pc,
      bmed = 0,
      cutoff = unique(proc_spid$cutoff),
      onesd = unique(proc_spid$onesd),
      aenm = aenm_fit,
      dtxsid = unique(proc_spid$dtxsid),
      casrn = NA,
      name = unique(proc_spid$name)
    )
    # run CR modeling (no gnls model)
    res <- concRespCore(
      dat.obj,
      fitmodels = c(
        "cnst", "hill", "poly1", "poly2", "pow", "exp2", "exp3", "exp4", "exp5"
      )
    )
    rownames(res) <- NULL
    # store results in final df
    fit_all <- rbind(fit_all, res)
  }
}
```

# Analyze Results

```{r combine-tiers}
# get Tier 1 results matching prospective chemicals/assays
tier1_chems <- httr_chems %>%
  mutate(
    signature = case_when(
      assay_target == "AHR" ~ "AHR_Agonist",
      assay_target == "GR" ~ "NR3C1_Agonist",
      assay_target == "hERG" ~ "hERG_Inhibitor",
      TRUE ~ "RAR_RXR_Agonist"
    )
  ) %>%
  left_join(
    ., select(
      combined_sum,
      dtxsid, signature, bmd_log, n_toxcast_meas,
      outcome_tier1, outcome_tier2, source_signature
    ),
    by = c("dtxsid", "signature"),
    relationship = "many-to-many"
  )
# de-duplicate Tier 1 results for multiple RAR/RXR signatures
tier1_chems <- tier1_chems %>%
  group_by(dtxsid, assay_target) %>%
  slice_min(bmd_log, n = 1) %>%
  ungroup()

# incorporate prospective profiling results
combined_prosp <- fit_all %>%
  mutate(
    assay_target = case_when(
      grepl("AHR", aenm) ~ "AHR",
      grepl("GR", aenm) ~ "GR",
      grepl("KCNH2", aenm) ~ "hERG",
      grepl("RARG", aenm) ~ "RARg",
      grepl("RXRB", aenm) ~ "RXRb"
    ),
    outcome_prosp = ifelse(
      hitcall >= 0.9 & top_over_cutoff >= 1, "Active", "Inactive"
    )
  ) %>%
  select(
    dtxsid, assay_target, aenm, hitcall,
    top_over_cutoff, acc, bmd, outcome_prosp
  ) %>%
  left_join(tier1_chems, ., by = c("dtxsid", "assay_target"))
```

## Classification of test chemicals

Chemical bioactivity classifications are defined as a continuous hitcall >= 0.9
and top_over_cutoff >= 1.

```{r analyze-classification}
# compare classification results as pie charts
plot_class <- combined_prosp %>%
  filter(reference_type == "None") %>%
  mutate(
    target_f = factor(
      assay_target, levels = c("AHR", "hERG", "RARg", "RXRb", "GR")
    )
  ) %>%
  count(target_f, outcome_prosp) %>%
  complete(target_f, outcome_prosp, fill = list(n = 0)) %>%
  group_by(target_f) %>%
  mutate(
    n_sum = sum(n),
    prop = n / n_sum,
    prop_label = case_when(
      prop > 0 ~ paste0(n, "\n(", round(prop * 100), "%)"),
      TRUE ~ ""
    )
  ) %>%
  ggplot(aes(x = target_f, y = n, fill = outcome_prosp, label = prop_label)) +
  # geom_col(color = "black") +
  # coord_polar(theta = "y") +
  # geom_text(position = position_stack(vjust = 0.5), family = "Helvetica") +
  # facet_wrap(~target_f, nrow = 3) +
  geom_col(position = position_fill()) +
  geom_text(position = position_fill(vjust = 0.5)) +
  scale_fill_brewer(palette = "Set2", direction = -1) +
  # scale_color_manual(values = c("black", "white")) +
  labs(x = "Target", y = "Proportion of Chemicals", fill = "Assay\nOutcome") +
  # theme_void() +
  theme_bw() +
  th

plot_class
```

### Compare to Hit Rates from Retrospective Analysis

To compare the rates of RCAS-predicted active/selective chemicals that were
active in prospective screening, hit rates from Tier 1 active/selective
chemicals in Tier 2 ToxCast endpoints are calculated from the retrospective
framework analysis.

```{r hit-rates-retrospective}
# plot hit rates of RCAS-predicted chemicals in Tier 2 orthogonal endpoints
plot_hitr <- combined_sum %>%
  filter(n_toxcast_meas >= 2 & outcome_tier1 == "selective") %>%
  count(source_signature, tier2_positive) %>%
  group_by(source_signature) %>%
  mutate(prop = n / sum(n), prop_label = paste0(n, "\n(", round(prop * 100), "%)")) %>%
  ungroup() %>%
  ggplot(aes(source_signature, n, fill = tier2_positive, label = prop_label)) +
  geom_col(position = position_fill()) +
  geom_text(position = position_fill(vjust = 0.5), family = "Helvetica") +
  labs(
    x = "RCAS", y = "Proportion of Chemicals",
    fill = "Active in Tier 2\nOrthogonal\nEndpoint"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 270, vjust = 0.5, hjust = 0)) +
  th
ggsave(
  "output/FigS8.png", plot_hitr,
  width = 720, height = 720, units = "px", scale = 2, bg = "white"
)
```

## Sensitivity of Potency Estimates

Tier 1 RCAS-derived PODs (`bmd_log`) are compared to potency values from
prospective assays to assess the relative sensitivity of each tiered result.

```{r analyze-potency}
# visualize trends between potency estimates
sum_potency <- combined_prosp %>%
  filter(outcome_prosp == "Active") %>%
  mutate(acc_log = log10(acc), diff_sq = (bmd_log - acc_log) ** 2) %>%
  summarise(
    rmsd = sqrt(mean(diff_sq)),
    cor_coef = cor.test(bmd_log, acc_log)$estimate,
    cor_p = cor.test(bmd_log, acc_log)$p.value
  ) %>%
  mutate(across(everything(), ~ ifelse(
    .x < 1E-3, formatC(.x, digits = 2, format = "e"), formatC(.x, digits = 3)
  )))
annot_potency <- paste0(
  "RMSD = ", sum_potency$rmsd, "\n",
  "r = ", sum_potency$cor_coef, "*"
)

plot_potency <- combined_prosp %>%
  filter(outcome_prosp == "Active") %>%
  mutate(
    acc_log = log10(acc),
    reference_type = case_when(
      reference_type == "None" ~ "Test Chemical",
      TRUE ~ "Positive\nReference\nChemical"
    ),
    target_f = factor(
      assay_target, levels = c("AHR", "hERG", "RARg", "RXRb", "GR")
    )
  ) %>%
  ggplot(
    aes(
      bmd_log, acc_log,
      color = target_f, shape = reference_type,
      label = stringr::str_trunc(name, 30)
    )
  ) +
  geom_abline(slope = 1, intercept = 0, color = "grey30") +
  geom_abline(
    slope = 1, intercept = c(-0.5, 0.5), color = "grey30", linetype = "dashed"
  ) +
  geom_point(size = 2) +
  geom_text_repel(
    min.segment.length = 0, size = 2.4, max.overlaps = 5, box.padding = 0.28,
    family = "Helvetica"
  ) +
  annotate(
    "text", x = 1.5, y = -2.5, label = annot_potency, family = "Helvetica"
  ) +
  scale_shape_manual(values = c(3, 16, 4)) +
  labs(
    x = expression(log[10](POD[RCAS])),
    y = expression(log[10](POD[Prospective])),
    color = "Target", shape = "Chemical Type"
  ) +
  theme_bw() +
  th

plot_potency
```

Spearman correlation coefficients of potency metrics are also determined
per assay.

```{r analyze-correlation}
cor_potency <- combined_prosp %>%
  filter(outcome_prosp == "Active") %>%
  mutate(
    acc_log = log10(acc),
    target_f = factor(
      assay_target,
      levels = c("AHR", "hERG", "RARg", "RXRb", "GR")
    )
  ) %>%
  group_by(target_f) %>%
  mutate(n_active = n()) %>%
  filter(n_active >= 3) %>%
  nest() %>%
  mutate(
    cor_obj = purrr::map(
      data, function(x) cor.test(x$bmd_log, x$acc_log, method = "spearman")
    ),
    cor_df = purrr::map(cor_obj, broom::tidy)
  ) %>%
  unnest(cor_df) %>%
  select(target_f, estimate, p.value)

cor_potency %>%
  mutate(across(c(estimate, p.value), ~ signif(.x, 2))) %>%
  DT::datatable()
```

```{r analysis-combined, class.source = 'fold-hide', warning=FALSE}
# plot correlation table as grob
tt <- gridExtra::ttheme_default(base_family = "Helvetica")
plot_cor <- cor_potency %>%
  mutate(
    estimate = signif(estimate, 2),
    p.value = case_when(
      p.value < 0.001 ~ formatC(p.value, format = "e", digits = 2),
      TRUE ~ as.character(signif(p.value, 2))
    )
  ) %>%
  rename(Target = target_f, `Spearman r` = estimate, `p-value` = p.value) %>%
  gridExtra::tableGrob(., rows = NULL, theme = tt)

# combine individual plots into single figure (Fig. 6)
plot_all <- cowplot::plot_grid(
  plot_class,
  # cowplot::plot_grid(
  #   NULL, plot_potency, plot_cor,
  #   ncol = 1, labels = c("B", "", "C"), rel_heights = c(0.2, 1, 0.8),
  #   label_fontfamily = "Helvetica"
  # ),
  plot_potency,
  align = "v", axis = "tblr",
  labels = c("A", "B"), nrow = 2, label_fontfamily = "Helvetica"
)
ggsave(
  paste0(dir_home, "output/Fig6.tiff"), plot_all,
  width = 1440, height = 1920, units = "px", bg = "white",
  device = "tiff", compression = "lzw"
)
```

# Reproducibility

```{r export-prospective}
# export chemicals with tier 1 active+selective outcome and insufficient
# orthogonal data in ToxCast (Table S3)

export_prosp <- combined_sum %>%
  filter(outcome_tier1 == "selective" & n_toxcast_meas < 2) %>%
  select(
    source_signature, dtxsid, name, bmd_log,
    threshold_1sd, outcome_tier1, n_toxcast_meas
  ) %>%
  arrange(source_signature, bmd_log) %>%
  mutate(
    profiled_endpoint = case_when(
      dtxsid %in% fit_all$dtxsid ~ fit_all$aenm[match(dtxsid, fit_all$dtxsid)]
    )
  )
colnames(export_prosp) <- c(
  "rcas", "dtxsid", "name", "rcas_bmd_log",
  "ns1_log", "outcome_tier1", "n_toxcast_meas", "profiled_endpoint"
)
openxlsx::write.xlsx(export_prosp, "output/TableS4.xlsx")
```

```{r reproducibility}
sessionInfo()
```