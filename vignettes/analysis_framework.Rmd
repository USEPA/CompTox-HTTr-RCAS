---
title: "Tiered Framework Assessment for Chemical Prioritization"
author: "Jesse Rogers"
date: "December 15, 2023"
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    df_print: paged
    code_folding: show
---

Assessment of current chemical screening data using a tiered NAM-based
framework to prioritize chemicals that perturb key molecular targets.

Chemicals are screened in Tier 1 using
[Reference Class Associated Signatures (RCAS)](analysis_RCAS.html),
initially for bioactivity (Tier 1-Positive) and additionally for selectivity
versus non-targeted transcriptional responses (Tier 1-Selective). Chemicals
with sufficient evidence of targeted behavior in Tier 1 are advanced
to confirmatory Tier 2 assays from the
[US EPA ToxCast program](https://www.epa.gov/chemical-research/exploring-toxcast-data)
using bioactivity and selectivity criteria.

![](Fig2A.png)

This framework was applied to 1,201 chemicals screened using high-throughtput
transcriptomics (HTTr). Chemicals with existing, orthogonal assay data in
ToxCast were used for retrospective evaluation of the framework's performance,
and a subset of chemicals with no orthogonal data were tested in a series of
targeted assays as a prospective screen of data-poor chemicals.

**Note**: Functions import ToxCast from InvitroDB using an internal 
MySQL database and is only available for internal use. However, this
method can be altered to work with a local instance of InvitroDB 
[available for public download](https://www.epa.gov/chemical-research/exploring-toxcast-data).

# Setup Environment

```{r env-setup, message=FALSE}
# import packages for visualization
# (note that other required packages will be imported by pipeline scripts)
library(ggplot2)
library(ComplexHeatmap)
library(RColorBrewer)
library(circlize)
library(ggsankey)
library(ggupset)
library(ggsignif)
library(ggrepel)
library(stringr)

# set directories (`dir_home` should be set to the top-level directory)
dir_home <- "~/NAM-integration/NAM-integration-pilot-packaged/"
dir_scripts <- paste0(dir_home, "scripts/")
setwd(dir_home)

# import scripts/data for RCAS profiling and framework assessment
source(paste0(dir_scripts, "pipeline_RCAS_profiling.R"))
source(paste0(dir_scripts, "pipeline_HTS_selection.R"))
source(paste0(dir_scripts, "pipeline_framework.R"))

path_rcas <- c(
  paste0(dir_home, "data/examples/rcas_heparg_gene_bnd.RData"),
  paste0(dir_home, "data/examples/rcas_u2os_gene_bnd.RData")
)

th <- theme(text = element_text(family = "Helvetica"))
th_sankey <- theme_sankey(base_family = "Helvetica")

# import tier 2 annotations for endpoint abbreviations (Table 1 from main text)
tier2_annot <- read.csv(
  paste0(dir_home, "data/Table1_Tier2Annotations.csv"),
  stringsAsFactors = FALSE
)

# import reference chemical annotations per cell line
rcas_heparg <- selectRCASGenes(path_rcas[1])
rcas_u2os <- selectRCASGenes(path_rcas[2])
```

# Select Orthogonal ToxCast Endpoints

Receptor-level endpoints from ToxCast are first selected for use in the tiered
framework as those that can distinguish in-class chemicals (i.e. those known
to activate/inhibit the target) from out-of-class chemicals (those known to
modulate some other target). RefChemDB annotations are used to designate
in-class/out-of-class chemicals (agnostic of RCAS). Bioactivity classification
performance and Wilcoxon rank-sum tests for potency estimates are used to test
whether each assay can delineate chemical categories.

Here, endpoints have been pre-selected using 13 reference chemical classes
specified during RCAS generation, and ToxCast data for pre-selected endpoints
are saved in the `data/examples` directory. Note that this script only needs to 
be run once for all analyses (and not per target).

```{r select-endpoints, eval=FALSE}
# set molecular targets for select assays for
# (manually set to those used for RCAS generation)
cluster_targets <- c(
  "ESR1_Positive", "AHR_Positive", "PTGS2_Negative",
  "AR_Positive", "RARA_Positive", "PPARA_Positive",
  "CA1_Negative|CA2_Negative", "CA1_Positive|CA2_Positive",
  "AR_Negative", "CYP19A1_Negative",
  "CA1_Negative|CA12_Negative|CA2_Negative|CA9_Negative",
  "KCNH2_Negative", "NR3C1_Positive"
)
# run assay selection for specified targets
# (filtered mc5/sc2 tables loaded from pre-generated tables)
path_mc5_selected <- paste0(
  dir_home, "data/examples/invitrodb_v3_4_selected.RData"
)
path_mc5_burst <- paste0(
  dir_home, "data/examples/invitrodb_v3_4_burst.RData"
)
path_mc5_ace <- paste0(
  dir_home, "data/examples/invitrodb_v3_4_assay_information.RData"
)
path_refchem <- paste0(dir_home, "data/examples/refchemdb_clusters.RData")
selectHTSEndpoints(
  cluster_targets,
  path_mc5_selected,
  filepath_save_burst = path_mc5_burst,
  filepath_load_refchem = path_refchem
)
```

# Generate Framework Results

Using previous HTTr (Tier 1) and ToxCast (Tier 2) targeted potency estimates,
the framework above is used to evaluate 1,201 chemicals screened in HTTr across
HepaRG and U-2 OS cell lines. 

Here, tiered framework results have been pre-generated using RCAS potency
estimates generated in the [RCAS analysis vignette](analysis_RCAS.html), and
results for each cell line are saved in the `data/examples` directory.

Note: `path_catalog` refers to previously generated signature-level
concentration-response profiles for 11,037 signatures in the HTTr signature
catalog in HepaRG and U-2 OS cell lines. Here, data are pulled for each cell
line from an internal directory, but data are available to view and download
publicly on the
[EPA CompTox Chemicals Dashboard](https://comptox.epa.gov/dashboard/).

```{r generate-framework, warning=FALSE, eval=FALSE}
# run tiered framework for heparg2d and u2os RCAS
path_cr <- c(
  "SIGNATURE_CR_rcas_res_httr_heparg2d_toxcast_gsea_0.05_conthits.RData",
  "SIGNATURE_CR_rcas_res_httr_u2os_toxcast_gsea_0.05_conthits.RData"
)
path_catalog <- paste0(
  "/ccte/projects1/HTTr/screen_signature_cr/signature_conc_resp/",
  "SIGNATURE_CR_screen_large_",
  c(
    "heparg2d_toxcast_pfas_pe1_normal_v2_gsea_0.05_conthits.RData",
    "u2os_toxcast_pfas_pe1_normal_v2_gsea_0.05_conthits.RData"
  )
)
path_export <- paste0(
  dir_home,
  c(
    "data/examples/framework_heparg.RData",
    "data/examples/framework_u2os.RData"
  )
)

for (idx in seq_len(length(path_cr))) {
  runFramework(
    path_rcas[idx],
    path_cr[idx],
    path_catalog[idx],
    path_mc5_selected,
    path_mc5_burst,
    path_mc5_ace,
    filepath_export = path_export[idx]
  )
}
```

```{r import-framework}
# load results for heparg/u2os cell lines + combine
path_export <- paste0(
  dir_home,
  c(
    "data/examples/framework_heparg.RData",
    "data/examples/framework_u2os.RData"
  )
)
load(path_export[1])
heparg_full <- compare_full
heparg_sum <- compare_sum
load(path_export[2])
u2os_full <- compare_full
u2os_sum <- compare_sum

# incorporate reference chemical annotations into full combined df
combined_full <- rbind(
  mutate(
    heparg_full,
    source = "heparg",
    ref_class = rcas_heparg$httr.wide$ref_class[
      match(dtxsid, rcas_heparg$httr.wide$dtxsid)
    ]
  ),
  mutate(
    u2os_full,
    source = "u2os",
    ref_class = rcas_u2os$httr.wide$ref_class[
      match(dtxsid, rcas_u2os$httr.wide$dtxsid)
    ]
  )
) %>%
  mutate(source_signature = gsub("_up|_dn", "", paste0(source, "_", signature)))

combined_sum <- rbind(
  mutate(heparg_sum, source = "heparg"),
  mutate(u2os_sum, source = "u2os")
) %>%
  mutate(source_signature = gsub("_up|_dn", "", paste0(source, "_", signature)))
```

# Analyze Framework Results

## Compare Chemical Prioritization

The attrition of chemicals across assessment criteria are summarized and
compared across molecular targets/cell lines using a Sankey plot.

```{r attrition-process}
# de-duplicate active/inactive signatures for dtxsids
combined_attr <- combined_sum %>%
  group_by(dtxsid) %>%
  summarise(
    tier1meas = "Profiled",
    tier1pos = list(source_signature[tier1_positive]),
    tier1sel = list(source_signature[tier1_positive & tier1_selective]),
    tier2meas = list(source_signature[tier1_positive & tier1_selective & n_toxcast_meas >= 2]),
    tier2pos = list(source_signature[tier1_positive & tier1_selective & tier2_positive & n_toxcast_meas >= 2]),
    tier2sel = list(source_signature[tier1_positive & tier1_selective & tier2_positive & tier2_selective & n_toxcast_meas >= 2])
  ) %>%
  mutate(
    tier1pos = case_when(
      lengths(tier1pos) > 1 ~ "Multiple",
      lengths(tier1pos) == 1 ~ paste(tier1pos),
      TRUE ~ "Negative"
    ),
    tier1sel = case_when(
      tier1pos == "Negative" ~ NA,
      lengths(tier1sel) > 1 ~ "Multiple",
      lengths(tier1sel) == 1 ~ paste(tier1sel),
      TRUE ~ "Positive Only"
    ),
    tier2pos = case_when(
      tier1sel %in% c("Multiple", unique(combined_sum$source_signature)) & lengths(tier2meas) == 0 ~ "Insufficient\nOrthogonal Data",
      tier1sel == "Positive Only" | is.na(tier1sel) ~ NA,
      lengths(tier2pos) > 1 ~ "Multiple",
      lengths(tier2pos) == 1 ~ paste(tier2pos),
      TRUE ~ "Negative"
    ),
    tier2sel = case_when(
      tier2pos == "Negative" | tier2pos == "Insufficient\nOrthogonal Data" | is.na(tier2pos) ~ NA,
      lengths(tier2sel) > 1 ~ "Multiple",
      lengths(tier2sel) == 1 ~ paste(tier2sel),
      TRUE ~ "Positive Only"
    )
  )

# generate color palettes
labels_attr <- c(
  unique(combined_sum$source_signature),
  "Multiple", "Profiled", "Negative", "Positive Only", "Insufficient\nOrthogonal Data"
)
fill_attr <- c(
  RColorBrewer::brewer.pal(6, "Dark2")[c(1, 3, 5, 2, 4, 6)],
  "#b1d4fc", rep("grey70", 2), "navy"
)
color_attr <- c(
  rep("grey10", 7), rep("grey30", 2), "navy"
)
names(fill_attr) <- labels_attr
names(color_attr) <- labels_attr

# get counts of chemicals for each rcas x assessment outcome
counts_attr <- combined_attr %>%
  make_long(tier1meas, tier1pos, tier1sel, tier2pos, tier2sel) %>%
  mutate(across(
    c(node, next_node), ~ factor(., levels = labels_attr)
  )) %>%
  filter(!is.na(node)) %>%
  group_by(x, node) %>%
  summarise(count = n(), .groups = "drop_last") %>%
  mutate(
    count_x = sum(count),
    pct = count / count_x * 100,
    count_label = case_when(
      x == "tier1meas" ~ gettextf("%d\nUnique\nChemicals", count),
      node %in% c("Negative", "Positive Only", "Insufficient\nOrthogonal Data") ~ gettextf(
        "%d\n%s", count, node
      ),
      # x == "tier2sel" & !node %in% c("Negative", "Positive Only", "Insufficient\nOrthogonal Data") ~ gettextf(
      #   "%d Candidates", count
      # ),
      TRUE ~ gettextf("%d", count)
    )
  )
```

```{r attrition-plot, class.source = 'fold-hide', fig.width=8, fig.height=4}
plot_attr <- combined_attr %>%
  make_long(tier1meas, tier1pos, tier1sel, tier2pos, tier2sel) %>%
  mutate(across(
    c(node, next_node), ~ factor(., levels = labels_attr)
  )) %>%
  left_join(., counts_attr, by = c("x", "node")) %>%
  ggplot(aes(
    x = x,
    next_x = next_x,
    node = node,
    next_node = next_node,
    fill = node,
    label = count_label
  )) +
  geom_sankey(na.rm = TRUE, flow.alpha = 0.6, space = 120) +
  geom_sankey_text(
    aes(color = node),
    size = 2.5,
    space = 120,
    hjust = 0,
    position = position_nudge(x = 0.1),
    lineheight = 0.8,
    family = "Helvetica"
  ) +
  geom_curve(
    aes(x = 4.5, y = 0, xend = 4.9, yend = 80),
    arrow = arrow(length = unit(0.01, "npc"), type = "closed"),
    lineend = "butt",
    # linejoin = "mitre",
    color = "navy",
    linewidth = 0.7,
    angle = 150,
    curvature = -0.4
  ) +
  geom_text(
    aes(x = 5, y = 80, label = "Prioritized for\nProspective\nProfiling"),
    color = "navy",
    size = 2.5,
    hjust = 0,
    nudge_x = 0.1,
    fontface = "plain",
    lineheight = 0.8,
    family = "Helvetica"
  ) +
  scale_fill_manual(
    values = fill_attr, breaks = labels_attr[1:6], na.value = "white"
  ) +
  scale_color_manual(
    values = color_attr, breaks = labels_attr[1:6], na.value = "white"
  ) +
  scale_x_discrete(labels = c(
    "Tier 1\nProfiled",
    "Tier 1\nPositive",
    "Tier 1\nPositive + Selective",
    "Tier 2\nPositive",
    "Tier 2\nPositive + Selective"
  )) +
  coord_cartesian(clip = "off") +
  labs(x = "", fill = "RCAS") +
  # theme_bw() +
  th_sankey +
  th +
  theme(
    axis.title.y = element_blank(),
    legend.position = c(0.75, 0.8),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 9),
    legend.key.size = unit(5, "mm"),
    plot.margin = unit(c(0, 1, 0, 0), "cm")
  ) +
  guides(color = "none", fill = guide_legend(reverse = TRUE, ncol = 2))

plot_attr
```

## Evaluate Tier 1 Performance: Association Tests

As an initial test for how well Tier 1 outcomes are associated
with targeted assay results, Fisher's exact tests are used to 
determine whether a positive outcome from each RCAS is assocaiated 
with a positive outcome from at least one orthogonal ToxCast endpoint.

```{r test-outcome-association, warning=FALSE}
# run exact tests on all rcas
calcFisher <- function(df, col_x, col_y, fisher = TRUE, simulate.p.values = FALSE) {
  contingency <- table(df[[col_x]], df[[col_y]], dnn = c(col_x, col_y))
  if (!any(dim(contingency) == 0)) {
    assoc <- chisq.test(contingency, simulate.p.value = simulate.p.values)
    assoc_export <- broom::tidy(assoc)
    if (fisher) {
      assoc_export$fisher.p.value <- fisher.test(contingency)$p.value
    } else {
      assoc_export$fisher.p.value <- NA
    }
    return(list(test = assoc_export, tbls = broom::augment(assoc)))
  } else {
    return(data.frame())
  }
}
calcOdds <- function(df, col_x, col_y) {
  contingency <- table(df[[col_x]], df[[col_y]], dnn = c(col_x, col_y))
  if (!any(dim(contingency) == 0)) {
    fisher <- fisher.test(contingency)
    fisher_export <- broom::tidy(fisher)
    return(fisher_export)
  } else {
    return(data.frame())
  }
}

# test associations and calculate odds ratios for all rcas but hERG_Inhibitor
  # (no Tier 2 multi-concentration bioactivity estimates available)
assoc_positive <- list(test = data.frame(), tbls = data.frame())
or_positive <- data.frame()
for (sig in unique(combined_sum$source_signature)) {
  assoc <- combined_sum %>%
    filter(source_signature == sig) %>%
    distinct(dtxsid, tier2_positive, .keep_all = TRUE) %>%
    calcFisher(., "tier1_positive", "tier2_positive")
  or <- combined_sum %>%
    filter(source_signature == sig) %>%
    distinct(dtxsid, tier2_positive, .keep_all = TRUE) %>%
    calcOdds(., "tier1_positive", "tier2_positive")
  if (sig != "heparg_hERG_Inhibitor") {
    assoc_positive$test <- rbind(assoc_positive$test, cbind(assoc$test, source_signature = sig))
    assoc_positive$tbls <- rbind(assoc_positive$tbls, cbind(assoc$tbls, source_signature = sig))
    or_positive <- rbind(or_positive, cbind(or, source_signature = sig))
  }
}

# test associations and calculate odds ratios for tier1-selective outcomes
assoc_selective <- list(test = data.frame(), tbls = data.frame())
or_selective <- data.frame()
for (sig in unique(combined_sum$source_signature)) {
  assoc <- combined_sum %>%
    filter(source_signature == sig) %>%
    distinct(dtxsid, tier2_selective, .keep_all = TRUE) %>%
    calcFisher(., "tier1_selective", "tier2_selective")
  or <- combined_sum %>%
    filter(source_signature == sig) %>%
    distinct(dtxsid, tier2_selective, .keep_all = TRUE) %>%
    calcOdds(., "tier1_selective", "tier2_selective")
  if (sig != "heparg_hERG_Inhibitor") {
    assoc_selective$test <- rbind(assoc_selective$test, cbind(assoc$test, source_signature = sig))
    assoc_selective$tbls <- rbind(assoc_selective$tbls, cbind(assoc$tbls, source_signature = sig))
    or_selective <- rbind(or_selective, cbind(or, source_signature = sig))
  }
}
```

```{r visualize-outcome-associations, class.source = 'fold-hide', fig.width=6, fig.height=3}
# visualize odds ratios
plot_or <- rbind(
  mutate(or_positive, comparison = "All Positive Chemicals"),
  mutate(or_selective, comparison = "Positive + Selective Chemicals")
) %>%
  mutate(
    comparison = factor(
      comparison, levels = c("All Positive Chemicals", "Positive + Selective Chemicals")
    ),
    p_label = ifelse(p.value < 0.05, "*", ""),
    p_x = ifelse(estimate < 30, conf.high + (0.4 * conf.high), conf.low - (0.4 * conf.low))
  ) %>%
  ggplot() +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey50") +
  geom_errorbar(
    aes(y = source_signature, xmin = conf.low, xmax = conf.high),
    width = 0.2
  ) +
  geom_text(
    aes(y = source_signature, x = p_x, label = p_label),
    size = 5, nudge_y = -0.1, family = "Helvetica"
  ) +
  geom_point(aes(estimate, source_signature), color = "red", size = 2) +
  scale_x_log10() +
  scale_y_discrete(limits = rev) +
  facet_wrap(~comparison) +
  labs(x = "Odds ratio (95% CI, log scale)", y = "RCAS", title = " ") +
  theme_bw() +
  th +
  theme(strip.background = element_blank(), strip.text.x = element_text(size = 10))

# combine plot with exact test p-values
# plot_pval <- or_positive %>%
#   mutate(p.value = signif(p.value, digits = 2), siglabel = as.factor(1:4)) %>%
#   ggplot(aes(x = as.factor(1), y = siglabel, label = p.value)) +
#   geom_text(size = 3) +
#   scale_y_discrete(limits = rev) +
#   labs(y = NULL, x = " ", title = "p-value") +
#   th +
#   theme(
#     plot.title = element_text(hjust = 0.5, size = 12),
#     axis.text.y = element_blank(),
#     axis.title.y = element_blank(),
#     axis.text.x = element_text(color = "white"),
#     axis.line = element_blank(),
#     axis.ticks.x = element_blank(),
#     axis.ticks.y = element_blank(),
#     panel.background = element_blank(),
#     panel.border = element_blank(),
#     panel.grid.major = element_blank(),
#     panel.grid.minor = element_blank(),
#     plot.background = element_blank()
#     # plot.margin = unit(c(5.5, 0, 5.5, 0), "pt")
#   )# +
#   # ggtitle("p-value")

# plot_or_all <- cowplot::plot_grid(
#   plot_or, plot_pval, nrow = 1, rel_widths = c(1, 0.2)
# )
# plot_or_all
```

```{r plot-fig2, class.source = 'fold-hide'}
# combine panels for Figure 2
fmwk <- png::readPNG(paste0(dir_home, "vignettes/Fig2A_detail.png"))
fmwk_grob <- grid::rasterGrob(fmwk)

plot_fig2 <- cowplot::plot_grid(
  fmwk_grob,
  plot_attr,
  plot_or + theme(plot.margin = unit(c(0, 1, 0.2, 1), "cm")),
  # cowplot::plot_grid(
  #   NULL, plot_or, plot_pval, NULL,
  #   nrow = 1, rel_widths = c(0.3, 1, 0.2, 0.3)
  # ),
  nrow = 3,
  rel_heights = c(0.7, 1.4, 0.8),
  # align = "h",
  # axis = "lrtb",
  labels = c("A", "B", "C"),
  label_fontfamily = "Helvetica"
)
ggsave(
  paste0(dir_home, "output/Fig2.png"), plot_fig2,
  width = 1000, height = 1400, units = "px", scale = 2, bg = "white"
)
```

## Evaluate Tier 1 Sensitivity: Mismatching Outcomes

In order to examine the extent to which Tier 1 targeted assessments fail to 
prioritize targeted perturbagens, Tier 2 potency estimates for chemicals with a
negative Tier 1 outcome and a positive or selective Tier 2 outcome are compared
to those with a positive or selective Tier 1 outcome via Kruskal-Wallis tests.

```{r test-mismatch-outcome}
# test for effect of tier 1 outcome on tier 2-positive/selective chemicals
mismatch_test <- combined_sum %>%
  filter(tier2_positive & n_toxcast_meas >= 2) %>%
  group_by(source_signature, tier2_selective) %>%
  mutate(n_groups = length(unique(outcome_tier1))) %>%
  filter(n_groups > 1) %>%
  nest() %>%
  mutate(
    kw = purrr::map(data, ~ kruskal.test(.x$modl_acc ~ .x$outcome_tier1)),
    kw_df = purrr::map(kw, broom::tidy)
  ) %>%
  unnest(kw_df) %>%
  ungroup() %>%
  mutate(fdr = p.adjust(p.value, method = "fdr"))

mismatch_test %>%
  select(-c(data, kw)) %>%
  mutate(across(where(is.numeric), ~ signif(.x, 2))) %>%
  rename(rcas = source_signature) %>%
  DT::datatable()
```

```{r test-mismatch-contrasts}
# test individual contrasts via Wilcoxon rank sum tests
mismatch_contr <- combined_sum %>%
  filter(tier2_positive & n_toxcast_meas >= 2) %>%
  group_by(source_signature, tier2_selective) %>%
  mutate(n_groups = length(unique(outcome_tier1))) %>%
  filter(n_groups > 1) %>%
  nest() %>%
  mutate(
    rs = purrr::map(
      data, ~ pairwise.wilcox.test(
        .x$modl_acc, .x$outcome_tier1,  p.adjust.method = "BH"
      )
    ),
    rs_df = purrr::map(rs, broom::tidy)
  ) %>%
  unnest(rs_df) %>%
  ungroup()

# visualize differences in potency across tier 2-selective only chemicals
contr_pos <- mismatch_contr %>%
  filter(!tier2_selective & group2 == "negative") %>%
  arrange(source_signature, group1) %>%
  mutate(p_label = case_when(
    p.value < 0.001 ~ formatC(p.value, format = "e", digits = 2),
    TRUE ~ as.character(signif(p.value, 2))
  )) %>%
  pull(p_label)

# repeat for tier 2-selective chemicals
contr_sel <- mismatch_contr %>%
  filter(tier2_selective & group2 == "negative") %>%
  arrange(source_signature, group1) %>%
  mutate(p_label = case_when(
    p.value < 0.001 ~ formatC(p.value, format = "e", digits = 2),
    TRUE ~ as.character(signif(p.value, 2))
  )) %>%
  pull(p_label)
```

```{r plot-mismatch-contrasts, class.source = 'fold-hide', fig.width=8, fig.height=4.8}
tier2_lim <- c(-2.5, 4)
plot_mismatch_pos <- combined_sum %>%
  filter(
    source_signature != "heparg_hERG_Inhibitor" &
      tier2_positive &
      !tier2_selective
  ) %>%
  mutate(
    outcome_tier1_label = case_when(
      outcome_tier1 == "positive" ~ "Positive Only",
      outcome_tier1 == "selective" ~ "Positive + Selective",
      outcome_tier1 == "negative" ~ "Negative"
    ),
    outcome_tier1_label = factor(
      outcome_tier1_label,
      levels = c("Negative", "Positive Only", "Positive + Selective")
    )
  ) %>%
  ggplot(aes(modl_acc, source_signature, color = outcome_tier1_label)) +
  geom_boxplot(na.rm = TRUE, outlier.shape = NA) +
  geom_point(
    na.rm = TRUE, size = 1, alpha = 0.5,
    position = position_jitterdodge(jitter.width = 0.1)
  ) +
  geom_signif(
    # y_position = c(3, 3.6, 3, 3.6, 3, 3.6),
    y_position = c(2.8, 3.4, 2.8, 3.4, 2.8, 3.4),
    xmin = c(0.7, 0.7, 1.7, 1.7, 3.7, 3.7),
    xmax = c(1, 1.3, 2, 2.3, 4, 4.3),
    annotation = contr_pos,
    tip_length = 0.01,
    color = "grey30",
    textsize = 3,
    family = "Helvetica"
  ) +
  scale_x_continuous(limits = tier2_lim) +
  labs(
    x = expression(log[10](POD[Orthogonal])), y = "RCAS", color = "Tier 1 Outcome",
    title = "Tier 2 Positive Only"
  ) +
  theme_bw() +
  th +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

plot_mismatch_sel <- combined_sum %>%
  filter(
    source_signature != "heparg_hERG_Inhibitor" &
      tier2_positive &
      tier2_selective
  ) %>%
  mutate(
    outcome_tier1_label = case_when(
      outcome_tier1 == "positive" ~ "Positive Only",
      outcome_tier1 == "selective" ~ "Positive + Selective",
      outcome_tier1 == "negative" ~ "Negative"
    ),
    outcome_tier1_label = factor(
      outcome_tier1_label,
      levels = c("Negative", "Positive Only", "Positive + Selective")
    )
  ) %>%
  ggplot(aes(modl_acc, source_signature, color = outcome_tier1_label)) +
  geom_boxplot(na.rm = TRUE, outlier.shape = NA) +
  geom_point(
    na.rm = TRUE, size = 1, alpha = 0.5,
    position = position_jitterdodge(jitter.width = 0.1)
  ) +
  geom_signif(
    # y_position = c(3, 3.6, 3, 3.6, 3, 3, 3.6),
    y_position = c(2.8, 3.4, 2.8, 3.4, 2.8, 2.8, 3.4),
    xmin = c(0.7, 0.7, 1.7, 1.7, 2.8, 3.7, 3.7),
    xmax = c(1, 1.3, 2, 2.3, 3.2, 4, 4.3),
    annotation = contr_sel,
    tip_length = 0.01,
    color = "grey30",
    textsize = 3,
    family = "Helvetica"
  ) +
  scale_x_continuous(limits = tier2_lim) +
  labs(
    x = expression(log[10](POD[Orthogonal])), y = "RCAS", color = "Tier 1 Outcome",
    title = "Tier 2 Positive + Selective"
  ) +
  theme_bw() +
  th +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

plot_mismatch_all <- cowplot::plot_grid(
  cowplot::plot_grid(
    plot_mismatch_pos + theme(legend.position = "none"),
    plot_mismatch_sel + theme(
      axis.text.y = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none"
    ),
    labels = c("A", "B"),
    label_fontfamily = "Helvetica",
    rel_widths = c(1, 0.65)
  ),
  cowplot::plot_grid(
    NULL, cowplot::get_legend(plot_mismatch_sel), rel_widths = c(0.2, 1)
  ),
  nrow = 2, rel_heights = c(1, 0.2)
)

ggsave(
  paste0(dir_home, "output/Fig3.png"), plot_mismatch_all,
  width = 1200, height = 720, units = "px", scale = 2, bg = "white"
)
plot_mismatch_all
```

## Compare Tier 1 POD Sensitivity

In order to examine whether RCAS-derived PODs are health-protective compared to
previous PODs derived from transcriptomics and targeted screening data, RCAS-
derived BMDs are compared to 5th percentile overall HTTr BMDs (i.e. Biological
Phenotype Altering Concentrations, BPACs) ($POD_{BPAC-HTTr}$) and ToxCast orthogonal
BMDs ($POD_{Orthogonal}$).

```{r pod-correlation}
# calculate correlation between RCAS BMDs and HTTr BPACs
calcCor <- function(combined_sum, col_compare, tier2 = FALSE) {
  if (tier2) {
    combined_filt <- combined_sum %>%
      filter(
        n_toxcast_meas >= 2 &
        outcome_tier1 == "selective" &
        outcome_tier2 != "negative"
      ) %>%
      group_by(source_signature, outcome_tier2)
  } else {
    combined_filt <- combined_sum %>%
      filter(outcome_tier1 != "negative") %>%
      group_by(source_signature, outcome_tier1)
  }
  cor_rcas <- combined_filt %>%
    distinct(dtxsid, source_signature, .keep_all = TRUE) %>%
    mutate(bmd_compare = !!as.name(col_compare)) %>%
    select(dtxsid, bmd_log, bmd_compare) %>%
    filter(!is.na(bmd_compare) & is.finite(bmd_compare)) %>%
    nest() %>%
    mutate(n_chems = unlist(purrr::map(data, nrow))) %>%
    filter(n_chems >= 3) %>%
    mutate(
      cor_obj = purrr::map(data, ~ cor.test(.x$bmd_log, .x$bmd_compare)),
      cor_df = purrr::map(cor_obj, broom::tidy)
    ) %>%
    unnest(cor_df) %>%
    mutate(
      cor_label = case_when(
        p.value <= 0.05 ~ paste0("r = ", round(estimate, 2), "*"),
        TRUE ~ paste0("r = ", round(estimate, 2))
      )
    ) %>%
    select(-data, -cor_obj)
  if (tier2) {
    cor_rcas <- mutate(
      cor_rcas,
      outcome_label = case_when(
        outcome_tier2 == "selective" ~ "Positive + Selective",
        TRUE ~ "Positive Only"
      )
    )
  } else {
    cor_rcas <- mutate(
      cor_rcas,
      outcome_label = case_when(
        outcome_tier1 == "selective" ~ "Positive + Selective",
        TRUE ~ "Positive Only"
      )
    )
  }
  return(cor_rcas)
}

cor_bpac <- calcCor(combined_sum, "bmd_log_5")
cor_bpac %>%
  select(-c(n_chems, alternative, cor_label, outcome_label, method)) %>%
  mutate(across(where(is.numeric), ~signif(.x, 2))) %>%
  DT::datatable()

cor_tier2 <- calcCor(combined_sum, "modl_acc", tier2 = TRUE)
cor_tier2 %>%
  select(-c(n_chems, alternative, cor_label, outcome_label, method)) %>%
  mutate(across(where(is.numeric), ~signif(.x, 2))) %>%
  DT::datatable()
```

```{r pod-comparison, class.source = 'fold-hide', fig.width=8, fig.height=6.3}
# plot RCAS BMDs against HTTr BPACs/Tier 2 PODs
plotPods <- function(combined_sum, cor_rcas, col_compare, label_compare, tier2 = FALSE) {
  if (tier2) {
    combined_filt <- filter(
      combined_sum,
      n_toxcast_meas >= 2 &
      outcome_tier1 == "selective" &
      outcome_tier2 != "negative"
    ) %>%
      mutate(
        outcome_label = case_when(
          outcome_tier2 == "selective" ~ "Positive + Selective",
          TRUE ~ "Positive Only"
        )
      )
  } else {
    combined_filt <- filter(combined_sum, outcome_tier1 != "negative") %>%
      mutate(
        outcome_label = case_when(
          outcome_tier1 == "selective" ~ "Positive + Selective",
          TRUE ~ "Positive Only"
        )
      )
  }
  plot_pod <- combined_filt %>%
    distinct(dtxsid, source_signature, .keep_all = TRUE) %>%
    ggplot(aes(bmd_log, !!as.name(col_compare), color = outcome_label)) +
    geom_point(na.rm = TRUE, alpha = 0.7) +
    geom_abline(
      slope = 1, intercept = c(-0.5, 0.5),
      linetype = "dashed", color = "grey50"
    ) +
    geom_abline(slope = 1, intercept = 0, color = "grey50") +
    geom_text(
      data = filter(cor_rcas, outcome_label == "Positive Only"),
      aes(label = cor_label),
      x = -1.8, y = 2.5, show.legend = FALSE, family = "Helvetica"
    ) +
    geom_text(
      data = filter(cor_rcas, outcome_label == "Positive + Selective"),
      aes(label = cor_label),
      x = -1.8, y = 1.8, show.legend = FALSE, family = "Helvetica"
    ) +
    facet_wrap(~source_signature, nrow = 1) +
    labs(
      x = bquote(log[10](POD[RCAS])),
      y = bquote(log[10](POD[.(label_compare)]))
    ) +
    scale_color_manual(values = scales::hue_pal()(3)[c(3, 2)]) +
    scale_x_continuous(limits = c(-3, 3)) +
    scale_y_continuous(limits = c(-3, 3)) +
    theme_bw() +
    th +
    theme(legend.position = "bottom") +
    guides(label = "none")

  if (tier2) {
    plot_pod <- plot_pod + labs(color = "Tier 2 Outcome")
  } else {
    plot_pod <- plot_pod + labs(color = "Tier 1 Outcome")
  }
  return(plot_pod)
}

plot_bpac <- plotPods(combined_sum, cor_bpac, "bmd_log_5", "BPAC1")
plot_tier2 <- plotPods(combined_sum, cor_tier2, "modl_acc", "Orthogonal", tier2 = TRUE)

# combine plots
guide_or <- guides(color = guide_legend(override.aes = list(alpha = 1, size = 2)))
plot_pod_all <- cowplot::plot_grid(
  plot_bpac + guide_or,
  plot_tier2 + guide_or,
  nrow = 2, labels = c("A", "B"), label_fontfamily = "Helvetica"
)
ggsave(
  paste0(dir_home, "output/Fig4.png"), plot_pod_all,
  width = 1400, height = 1100, units = "px", bg = "white", scale = 2
)

plot_pod_all
```

```{r pod-comparison-bpac2}
# plot RCAS BMDs against Tier 2 BPACs (POD_BPAC2)
cor_bpac2 <- calcCor(combined_sum, "modl_acc_5", tier2 = FALSE)
cor_bpac2 %>%
  select(-c(n_chems, alternative, cor_label, outcome_label, method)) %>%
  mutate(across(where(is.numeric), ~signif(.x, 2))) %>%
  DT::datatable()

plot_bpac2 <- plotPods(combined_sum, cor_bpac2, "modl_acc_5", "BPAC2", tier2 = FALSE)
ggsave(
  paste0(dir_home, "output/FigS4.png"), plot_bpac2,
  width = 1400, height = 480, units = "px", bg = "white", scale = 2
)
```

## Inspect Candidate Perturbagens

Tier 1/2 data are compiled for chemicals that met tier1- and tier2-selective
criteria for comparison of potency estimates across targeted assays. PODs
include $POD_{RCAS}$, $POD_{Orthogonal}$, and non-selective ToxCast-derived PODs
($POD_{NS-ToxCast}$)

Chemical structure images used in Fig. 5 were downloaded from the 
[EPA CompTox Chemicals Dashboard](https://comptox.epa.gov/dashboard/), and were
stored in the `data/ccd_structures` directory using a
`structure_<chem_name>.png` naming convention (not included in repo due to size
constraints).

```{r inspect-candidates}
# filter data per target + process for plotting
compileTargetData <- function(combined_full, rcas, struct) {
  combined_full <- arrange(combined_full, signature_label, source)
  combined_filt <- combined_full %>%
    filter(
      source_signature == rcas &
        tier1_selective &
        tier2_selective &
        n_toxcast_meas >= 2
    )
  combined_proc <- combined_filt %>%
    group_by(dtxsid) %>%
    mutate(
      n_specific = n(),
      aenm_annot = tier2_annot[["Ref."]][
        match(aenm, tier2_annot[["Assay.Endpoint"]])
      ],
      aenms_specific = list(aenm_annot),
      chem_category = case_when(
        !is.na(ref_class) & ref_class == signature_label ~ "in-class reference",
        !is.na(ref_class) & ref_class != signature_label ~ "out-of-class reference",
        is.na(ref_class) ~ "test chemical"
      ),
      signature_f = case_when(
        chem_category == "in-class reference" ~ "Reference Chemical",
        TRUE ~ paste0("Tier 1/2 Candidate: ", source_signature)
      ),
      signature_f = factor(
        signature_f,
        levels = c(
          "Reference Chemical", paste0(
            "Tier 1/2 Candidate: ", unique(
              filter(
                combined_full,
                tier1_selective & tier2_selective & n_toxcast_meas >= 2
              )$source_signature
            )
          )
        )
      ),
      signature_s = as.character(signature_f),
      name_label = case_when(
        tolower(gsub(",", "-", name)) %in% names(struct) |
          chem_category == "in-class reference" ~ name,
        TRUE ~ ""
      )
    ) %>%
    slice_min(modl_acc, n = 1) %>%
    ungroup() %>%
    mutate(acc_rank = row_number(modl_acc)) %>%
    group_by(dtxsid) %>%
    pivot_longer(
      cols = c(modl_acc, modl_acc_mode, bmd_log),
      names_to = "metric",
      values_to = "value"
    )
  return(combined_proc)
}
```

```{r plot-candidate-fcn, class.source = 'fold-hide'}
plotCandidates <- function(combined_proc) {
  plot_set <- sort(unique(unlist(pull(combined_proc, aenms_specific))))
  plot_candidates <- ggplot() +
    geom_line(
      data = filter(combined_proc, metric != "bmd_log"),
      aes(x = aenms_specific, y = value, color = signature_f, group = acc_rank),
      alpha = 0.8, position = position_dodge(width = .7)
    ) +
    geom_point(
      data = combined_proc,
      aes(
        x = aenms_specific, y = value,
        color = signature_f, group = acc_rank, shape = metric
      ),
      size = 2, alpha = 0.8, fill = "white",
      position = position_dodge(width = .7)
    ) +
    scale_x_upset(order_by = "degree", sets = plot_set) +
    geom_text_repel(
      data = filter(combined_proc, metric == "modl_acc"),
      aes(
        x = aenms_specific, y = value,
        color = signature_f, group = acc_rank, label = name_label
      ),
      position = position_dodge(width = 0.7),
      max.overlaps = 50,
      size = 3,
      min.segment.length = 0,
      box.padding = 1,
      segment.curvature = 0.4,
      segment.ncp = 3,
      segment.angle = 20,
      segment.linetype = 3
    ) +
    scale_color_manual(
      values = c(
        "grey50",
        brewer.pal(length(levels(combined_proc$signature_f)) - 1, "Dark2")
      ), drop = FALSE
    ) +
    scale_shape_manual(
      values = c(4, 16, 21),
      labels = expression(POD[RCAS], POD[Orthogonal], POD[`NS2`])
    ) +
    # facet_wrap(~source_signature, nrow = 1) +
    labs(
      x = "", y = "log10(POD)",
      shape = "Metric", color = "Chemical Type"
    ) +
    theme_bw() +
    th +
    guides(
      shape = guide_legend(nrow = 1, label.hjust = 0),
      color = guide_legend(ncol = 1)
    )
  return(plot_candidates)
}
```

```{r plot-structures}
# import pngs for chemical structures
dir_structs <- paste0(dir_home, "data/ccd_structures/")
structs <- list()
for (filename_struct in list.files(dir_structs)) {
  chemname <- gsub(".png", "", gsub("structure_", "", filename_struct))
  struct_png <- png::readPNG(paste0(dir_structs, filename_struct))
  # struct_dim <- dim(struct_png)[2:1]
  struct_grob <- grid::rasterGrob(struct_png)
  structs[[chemname]] <- struct_grob
}
struct_plot <- list()
struct_plot[["AHR"]] <- cowplot::plot_grid(
  structs[["1-4-diaminoanthraquinone"]], structs[["3-hydroxyfluorene"]],
  structs[["2-aminoanthraquinone"]],
  labels = c("1,4-Diaminoanthraquinone", "3-Hydroxyfluorene", "2-Aminoanthraquinone"),
  label_fontface = "plain", label_size = 10, label_fontfamily = "Helvetica",
  label_x = 0.5, label_y = 1, hjust = 0.5
)
struct_plot[["GR"]] <- cowplot::plot_grid(
  structs[["fluorometholone"]], structs[["budesonide"]],
  structs[["medroxyprogesterone-acetate"]],
  labels = c("Fluorometholone", "Budesonide", "Medroxyprogesterone acetate"),
  label_fontface = "plain", label_size = 10, label_fontfamily = "Helvetica",
  label_x = 0.5, label_y = 1, hjust = 0.5
)
struct_plot[["RAR"]] <- cowplot::plot_grid(
  structs[["etoxazole"]], structs[["imazalil"]],
  structs[["dieldrin"]], structs[["aldrin"]],
  labels = c("Etoxazole", "Imazalil", "Dieldrin", "Aldrin"),
  label_fontface = "plain", label_size = 10, label_fontfamily = "Helvetica",
  label_x = 0.5, label_y = 1, hjust = 0.5
)
```

```{r plot-candidates, class.source = 'fold-hide', fig.width=8, fig.height=12}
plots_candidate <- list()
for (target in unique(combined_full$source_signature)) {
  if (target != "heparg_hERG_Inhibitor") {
    combined_target <- compileTargetData(combined_full, target, structs)
    plots_candidate[[target]] <- plotCandidates(combined_target)
  }
}

# pull legend for separate panel
lgd <- cowplot::get_legend(
  plots_candidate[["heparg_AHR_Agonist"]] +
    theme(legend.position = "right") +
    guides(
      shape = guide_legend(nrow = 1, title = "Metric", label.hjust = 0),
      color = guide_legend(
        title = "Chemical Type", override.aes = list(label = "", alpha = 1)
      ),
    )
)
# combine figure panels (Fig. 5)
plots_candidate_struct <- cowplot::plot_grid(
  plots_candidate[["heparg_AHR_Agonist"]] + theme(legend.position = "none"),
  struct_plot[["AHR"]],
  plots_candidate[["u2os_NR3C1_Agonist"]] + theme(legend.position = "none"),
  struct_plot[["GR"]],
  plots_candidate[["heparg_RAR_RXR_Agonist"]] + theme(legend.position = "none"),
  struct_plot[["RAR"]],
  plots_candidate[["u2os_RAR_RXR_Agonist"]] + theme(legend.position = "none"),
  lgd,
  labels = c("A", "", "B", "", "C", "", "D", ""),
  label_fontfamily = "Helvetica",
  axis = "btlr",
  align = "v",
  ncol = 2
)
ggsave(
  paste0(dir_home, "output/Fig5.png"), plots_candidate_struct,
  width = 1600, height = 2400, units = "px", scale = 1.6, bg = "white"
)
plots_candidate_struct
```

# Reproducibility

```{r reproducibility}
sessionInfo()
```