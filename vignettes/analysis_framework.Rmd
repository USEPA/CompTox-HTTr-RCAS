---
title: "Tiered Framework Assessment for Chemical Prioritization"
author: "Jesse Rogers"
date: "December 15, 2023"
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    df_print: paged
    code_folding: show
---

Assessment of current chemical screening data using a tiered NAM-based
framework to prioritize chemicals that perturb key molecular targets.

Chemicals are screened in Tier 1 using
[Reference Class Associated Signatures(RCAS)](analysis_RCAS.Rmd),
initially for bioactivity (Tier 1-Positive) and additionally for selectivity
versus non-targeted transcriptional responses (Tier 1-Selective). Chemicals
with sufficient evidence of targeted behavior in Tier 1 are advanced
to confirmatory Tier 2 assays from the
[US EPA ToxCast program](https://www.epa.gov/chemical-research/exploring-toxcast-data)
using bioactivity and selectivity criteria.

![](Fig2A.png)

This framework was applied to 1,201 chemicals screened using high-throughtput
transcriptomics (HTTr). Chemicals with existing, orthogonal assay data in
ToxCast were used for retrospective evaluation of the framework's performance,
and a subset of chemicals with no orthogonal data were tested in a series of
targeted assays as a prospective screen of data-poor chemicals.

**Note**: Functions import ToxCast from InvitroDB using an internal 
MySQL database and is only available for internal use. However, this
method can be altered to work with a local instance of InvitroDB 
[available for public download here](https://www.epa.gov/chemical-research/exploring-toxcast-data).

# Setup Environment

```{r env-setup, message=FALSE}
# import packages for visualization
# (note that other required packages will be imported by R scripts)
library(ggplot2)
library(ComplexHeatmap)
library(RColorBrewer)
library(circlize)
library(ggsankey)
library(ggupset)

# set directories (`dir_home` should be set to the top-level directory)
dir_home <- "~/NAM-integration/NAM-integration-pilot-packaged/"
dir_scripts <- paste0(dir_home, "scripts/")
setwd(dir_home)

# import scripts/data for RCAS profiling and framework assessment
source(paste0(dir_scripts, "pipeline_RCAS_profiling.R"))
source(paste0(dir_scripts, "pipeline_HTS_selection.R"))
source(paste0(dir_scripts, "pipeline_framework.R"))

path_rcas <- c(
  paste0(dir_home, "data/examples/rcas_heparg_gene.RData"),
  paste0(dir_home, "data/examples/rcas_u2os_gene.RData")
)
```

# Select Orthogonal ToxCast Endpoints

Receptor-level endpoints from ToxCast are first selected for use in the tiered
framework as those that can distinguish in-class chemicals (i.e. those known
to activate/inhibit the target) from out-of-class chemicals (those known to
modulate some other target). RefChemDB annotations are used to designate
in-class/out-of-class chemicals (agnostic of RCAS). Bioactivity classification
performance and Wilcoxon rank-sum tests for potency estimates are used to test
whether each assay can delineate chemical categories.

```{r select-endpoints, eval=FALSE}
# set molecular targets for select assays for
# (manually set to those used for RCAS generation)
cluster_targets <- c(
  "ESR1_Positive", "AHR_Positive", "PTGS2_Negative",
  "AR_Positive", "RARA_Positive", "PPARA_Positive",
  "CA1_Negative|CA2_Negative", "CA1_Positive|CA2_Positive",
  "AR_Negative", "CYP19A1_Negative",
  "CA1_Negative|CA12_Negative|CA2_Negative|CA9_Negative",
  "KCNH2_Negative", "NR3C1_Positive"
)
# run assay selection for specified targets
# (filtered mc5/sc2 tables loaded from pre-generated tables)
path_mc5_selected <- paste0(
  dir_home, "data/examples/invitrodb_v3_4_selected.RData"
)
path_mc5_burst <- paste0(
  dir_home, "data/examples/invitrodb_v3_4_burst.RData"
)
path_mc5_ace <- paste0(
  dir_home, "data/examples/invitrodb_v3_4_assay_information.RData"
)
path_refchem <- paste0(dir_home, "data/examples/refchemdb_clusters.RData")
selectHTSEndpoints(
  cluster_targets,
  path_mc5_selected,
  filepath_save_burst = path_mc5_burst,
  filepath_load_refchem = path_refchem
)
```

# Generate Framework Results

Using previous HTTr (Tier 1) and ToxCast (Tier 2) targeted potency estimates,
the framework above is used to evaluate 1,201 chemicals screened in HTTr across
HepaRG and U-2 OS cell lines. 

Note: `path_catalog` refers to previously generated signature-level
concentration-response profiles for 11,037 signatures in the HTTr signature
catalog in HepaRG and U-2 OS cell lines. Here, data are pulled for each cell
line from an internal directory, but data are available to view and download
publicly on the
[EPA CompTox Chemicals Dashboard](https://comptox.epa.gov/dashboard/).

```{r generate-framework, warning=FALSE, eval=FALSE}
# run tiered framework for heparg2d and u2os RCAS
path_cr <- c(
  "SIGNATURE_CR_rcas_res_httr_heparg2d_toxcast_gsea_0.05_conthits.RData",
  "SIGNATURE_CR_rcas_res_httr_u2os_toxcast_gsea_0.05_conthits.RData"
)
path_catalog <- paste0(
  "/ccte/projects1/HTTr/screen_signature_cr/signature_conc_resp/",
  "SIGNATURE_CR_screen_large_",
  c(
    "heparg2d_toxcast_pfas_pe1_normal_v2_gsea_0.05_conthits.RData",
    "u2os_toxcast_pfas_pe1_normal_v2_gsea_0.05_conthits.RData"
  )
)
path_export <- paste0(
  dir_home,
  c(
    "data/examples/framework_heparg.RData",
    "data/examples/framework_u2os.RData"
  )
)

for (idx in seq_len(length(path_cr))) {
  runFramework(
    path_rcas[idx],
    path_cr[idx],
    path_catalog[idx],
    path_mc5_selected,
    path_mc5_burst,
    path_mc5_ace,
    filepath_export = path_export[idx]
  )
}
```

Here, framework results are pre-generated and saved in the `data/examples` 
directory.

```{r import-framework}
# load results for heparg/u2os cell lines + combine
path_export <- paste0(
  dir_home,
  c(
    "data/examples/framework_heparg.RData",
    "data/examples/framework_u2os.RData"
  )
)
load(path_export[1])
heparg_full <- compare_full
heparg_sum <- compare_sum
load(path_export[2])
u2os_full <- compare_full
u2os_sum <- compare_sum

combined_full <- rbind(
  mutate(heparg_full, source = "heparg"),
  mutate(u2os_full, source = "u2os")
)
combined_sum <- rbind(
  mutate(heparg_sum, source = "heparg"),
  mutate(u2os_sum, source = "u2os")
)
```

# Analyze Framework Results

## Compare Chemical Prioritization

The attrition of chemicals across assessment criteria are summarized and
compared across molecular targets/cell lines.

```{r attrition-process}
# de-duplicate inactive signatures for dtxsids
combined_attr <- combined_sum %>%
  mutate(source_signature = paste0(source, "_", signature)) %>%
  group_by(dtxsid) %>%
  mutate(
    multi_positive = sum(tier1_positive) > 0,
    rank_signature = row_number(),
    keep_signature = case_when(
      multi_positive ~ tier1_positive,
      TRUE ~ rank_signature == 1
    )
  ) %>%
  ungroup() %>%
  filter(keep_signature)

# generate labels for attrition plot
combined_attr <- combined_attr %>%
  mutate(
    tier1meas = "Profiled",
    tier2_measured = tier1_selective & n_toxcast_meas >= 2,
    tier1pos = case_when(
      tier1_positive ~ source_signature, TRUE ~ "Negative"
    ),
    tier1sel = case_when(
      tier1_positive & tier1_selective ~ source_signature,
      tier1_positive & !tier1_selective ~ "Non-selective"
    ),
    tier2pos = case_when(
      tier1_selective & n_toxcast_meas >= 2 & tier2_positive ~ source_signature,
      tier1_selective & n_toxcast_meas >= 2 & !tier2_positive ~ "Negative",
      tier1_selective & n_toxcast_meas < 2 ~ "No Orthogonal\nEndpoints"
    ),
    tier2sel = case_when(
      tier1_selective & tier2_measured & tier2_positive & tier2_selective ~ source_signature,
      tier1_selective & tier2_measured & tier2_positive & !tier2_selective ~ "Non-selective"
    )
  )

# generate color palettes
labels_attr <- c(
  unique(combined_attr$source_signature),
  "Profiled", "Negative", "Non-selective", "No Orthogonal\nEndpoints"
)
fill_attr <- c(
  RColorBrewer::brewer.pal(5, "Dark2")[c(1, 3, 5, 4, 2)],
  "#b1d4fc", rep("grey70", 2), "navy"
)
color_attr <- c(
  RColorBrewer::brewer.pal(5, "Dark2")[c(1, 3, 5, 4, 2)],
  "#377ac7", rep("grey30", 2), "navy"
)
names(fill_attr) <- labels_attr
names(color_attr) <- labels_attr

# get counts of chemicals for each rcas x assessment outcome
counts_attr <- combined_attr %>%
  make_long(tier1meas, tier1pos, tier1sel, tier2pos, tier2sel) %>%
  mutate(across(
    c(node, next_node), ~ factor(., levels = labels_attr)
  )) %>%
  filter(!is.na(node)) %>%
  group_by(x, node) %>%
  summarise(count = n(), .groups = "drop_last") %>%
  mutate(
    count_x = sum(count),
    pct = count / count_x * 100,
    count_label = case_when(
      x == "tier1meas" ~ "1201",
      node %in% c("Negative", "Non-selective", "No Orthogonal\nEndpoints") ~ gettextf(
        "%d\n%s", count, node
      ),
      x == "tier2sel" & !node %in% c("Negative", "Non-selective", "No Orthogonal\nEndpoints") ~ gettextf(
        "%d Candidates", count
      ),
      TRUE ~ gettextf("%d", count)
    )
  )
```

```{r attrition-plot, fig.width=8, fig.height=4}
plot_attr <- combined_attr %>%
  make_long(tier1meas, tier1pos, tier1sel, tier2pos, tier2sel) %>%
  mutate(across(
    c(node, next_node), ~ factor(., levels = labels_attr)
  )) %>%
  left_join(., counts_attr, by = c("x", "node")) %>%
  ggplot(aes(
    x = x,
    next_x = next_x,
    node = node,
    next_node = next_node,
    fill = node,
    label = count_label
  )) +
  geom_sankey(na.rm = TRUE, flow.alpha = 0.6, space = 100) +
  geom_sankey_text(
    aes(color = node),
    size = 2.2,
    space = 100,
    hjust = 0,
    position = position_nudge(x = 0.1),
    lineheight = 0.8
  ) +
  geom_segment(
    aes(x = 4.75, y = -239, xend = 5, yend = -239),
    arrow = arrow(length = unit(0.005, "npc"), type = "closed"),
    lineend = "butt",
    linejoin = "mitre",
    color = "navy",
    linewidth = 2.2
  ) +
  geom_text(
    aes(x = 5, y = -239, label = "Prioritized for\nTargeted Assays"),
    color = "navy",
    size = 2.2,
    hjust = 0,
    nudge_x = 0.1,
    fontface = "plain"
  ) +
  scale_fill_manual(
    values = fill_attr, breaks = labels_attr[1:5], na.value = "white"
  ) +
  scale_color_manual(
    values = color_attr, breaks = labels_attr[1:5], na.value = "white"
  ) +
  scale_x_discrete(labels = c(
    "Tier 1\nProfiled",
    "Tier 1\nPositive",
    "Tier 1\nSelective",
    "Tier 2\nPositive",
    "Tier 2\nSelective"
  )) +
  coord_cartesian(clip = "off") +
  labs(x = "", fill = "RCAS") +
  # theme_bw() +
  theme_sankey() +
  theme(
    axis.title.y = element_blank(),
    legend.position = c(0.85, 0.75),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 9),
    legend.key.size = unit(5, "mm"),
    plot.margin = unit(c(0, 1, 0, 0), "cm")
  ) +
  guides(color = "none", fill = guide_legend(reverse = TRUE))

plot_attr
```

# Reproducibility

```{r reproducibility}
sessionInfo()
```